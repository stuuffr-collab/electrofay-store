ğŸ“Œ Prompt: Dynamic Pricing (USD â†’ LYD) for electrofay-store (Supabase + Node + Vite)
Ø§Ù„Ù‡Ø¯Ù

ØªØ®Ø²ÙŠÙ† Ø³Ø¹Ø± ÙƒÙ„ Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± base_price_usd.

Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø²Ø¨ÙˆÙ† Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ù„ÙŠØ¨ÙŠ display_price_lyd Ø§Ø¹ØªÙ…Ø§Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø³Ø¹Ø± ØµØ±Ù Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø¯ÙŠØ«.

Ù‚ÙÙ„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ (Snapshot) Ø­ØªÙ‰ Ù„Ùˆ ØªØºÙŠÙ‘Ø± Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù„Ø§Ø­Ù‚Ù‹Ø§.

Ø®ÙŠØ§Ø± A (Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ù„Ø¨Ø¯Ø¡ â€“ MVP Ø¢Ù…Ù† ÙˆØ¨Ø³ÙŠØ·)
1) Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Supabase/Postgres)

Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:

create table if not exists public.products (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  base_price_usd numeric(10,2) not null,
  is_active boolean not null default true,
  created_at timestamptz not null default now()
);


Ø¬Ø¯ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ù‘Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·:

create table if not exists public.settings (
  key text primary key,
  value jsonb not null,
  updated_at timestamptz not null default now()
);

-- Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø«Ø§Ù„: 1 USD = 5.0 LYD)
insert into public.settings (key, value) values
('usd_to_lyd', jsonb_build_object('rate', 5.0))
on conflict (key) do update
set value = excluded.value, updated_at = now();


RLS:

-- ÙØ¹Ù‘Ù„ RLS Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ†
alter table public.products enable row level security;
alter table public.settings enable row level security;

-- Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª ÙÙ‚Ø·)
create policy "public read products"
on public.products for select
to anon using (is_active = true);

-- Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© (usd_to_lyd) ÙÙ‚Ø· Ù„Ù„Ø¬Ù…ÙŠØ¹
create policy "public read usd_to_lyd"
on public.settings for select
to anon using (key = 'usd_to_lyd');

-- Ù…Ù†Ø¹ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† anon
revoke all on table public.products from anon;
revoke all on table public.settings from anon;

2) Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (Frontend + Ø¹Ø±Ø¶ ÙÙ‚Ø·)

ÙÙŠ Vite/React:

// supabaseClient.ts
import { createClient } from '@supabase/supabase-js'

export const supabase = createClient(
  import.meta.env.VITE_SUPABASE_URL!,
  import.meta.env.VITE_SUPABASE_ANON_KEY!
)

// productsService.ts
import { supabase } from './supabaseClient'

export async function fetchPricedProducts() {
  const [{ data: products, error: pErr }, { data: settings, error: sErr }] =
    await Promise.all([
      supabase.from('products').select('id,name,base_price_usd').eq('is_active', true),
      supabase.from('settings').select('value').eq('key', 'usd_to_lyd').single()
    ])

  if (pErr) throw pErr
  if (sErr) throw sErr

  const rate = Number(settings?.value?.rate ?? 0)
  return (products ?? []).map(p => {
    const raw = Number(p.base_price_usd) * rate
    const rounded = roundLYD(raw) // Ø´ÙˆÙ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ­Øª
    return { ...p, display_price_lyd: rounded, usd_to_lyd: rate }
  })
}

// Ù‚Ø§Ø¹Ø¯Ø© ØªÙ‚Ø±ÙŠØ¨ (Ù…Ø«Ø§Ù„: Ù„Ø£Ù‚Ø±Ø¨ 0.5 Ø¯ÙŠÙ†Ø§Ø±)
function roundLYD(value: number) {
  const step = 0.5
  return Math.round(value / step) * step
}


Ù…Ù‡Ù…: Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·. Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØªÙ… ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆÙ‚Øª Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†.

3) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ (Backend â€“ Ù‚ÙÙ„ Ø§Ù„Ø³Ø¹Ø± Snapshot)

Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ¨Ù†ÙˆØ¯Ù‡Ø§:

create table if not exists public.orders (
  id uuid primary key default gen_random_uuid(),
  user_id uuid,
  created_at timestamptz not null default now()
);

create table if not exists public.order_items (
  id uuid primary key default gen_random_uuid(),
  order_id uuid references public.orders(id) on delete cascade,
  product_id uuid references public.products(id),
  qty int not null check (qty > 0),
  unit_price_usd numeric(10,2) not null,
  usd_to_lyd numeric(12,6) not null,           -- Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨
  unit_price_lyd numeric(12,2) generated always as (unit_price_usd * usd_to_lyd) stored,
  created_at timestamptz not null default now()
);


ÙÙŠ Express/Node (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… service role ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙ‚Ø·):

import { createClient } from '@supabase/supabase-js'
import type { Request, Response } from 'express'

const supabase = createClient(
  process.env.VITE_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // Ø³Ø±ÙŠ
)

export async function createOrder(req: Request, res: Response) {
  const { items } = req.body as { items: { product_id: string; qty: number }[] }

  // 1) Ø¬ÙŠØ¨ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† settings
  const { data: setting, error: sErr } = await supabase
    .from('settings').select('value').eq('key', 'usd_to_lyd').single()
  if (sErr) return res.status(500).json({ message: sErr.message })
  const rate = Number(setting?.value?.rate)
  if (!rate) return res.status(500).json({ message: 'Exchange rate not set' })

  // 2) Ø¬ÙŠØ¨ Ø£Ø³Ø¹Ø§Ø± USD Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  const ids = items.map(i => i.product_id)
  const { data: products, error: pErr } = await supabase
    .from('products')
    .select('id, base_price_usd')
    .in('id', ids)
  if (pErr) return res.status(500).json({ message: pErr.message })

  // 3) Ø£Ù†Ø´Ø¦ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¨Ù†ÙˆØ¯Ù‡ (Ø³Ø¹Ø± USD + snapshot Ù„Ù€ rate)
  const { data: order, error: oErr } = await supabase
    .from('orders').insert({}).select('id').single()
  if (oErr) return res.status(500).json({ message: oErr.message })

  const itemsRows = items.map(i => {
    const p = products!.find(x => x.id === i.product_id)!
    return {
      order_id: order.id,
      product_id: i.product_id,
      qty: i.qty,
      unit_price_usd: p.base_price_usd,
      usd_to_lyd: rate
      // unit_price_lyd ÙŠÙØ­ØªØ³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù€ generated column
    }
  })

  const { error: oiErr } = await supabase.from('order_items').insert(itemsRows)
  if (oiErr) return res.status(500).json({ message: oiErr.message })

  return res.json({ order_id: order.id })
}


Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ØŒ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªØ¸Ù„ Ø«Ø§Ø¨ØªØ© Ø­ØªÙ‰ Ù„Ùˆ ØªØºÙŠÙ‘Ø± Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©.